{% extends "home.html" %}

{% block home %}
{% load static %}
<h1 class="text-center text-white" style=" letter-spacing: 1px;font-family:'Times New Roman', Times, serif;font-weight: bold;">My Shipments</h1>
<div class="row" style="width: 100%;">
    {% for i in data %}
    <div class="col-lg-3 " >
      <div class="card mt-2 ml-1">         
        <div class="card card-body">
          <h4 class="card-title text-center">{{i.name}}</h4>
          {% if i.img  %}
            <img src="{{ i.img.url }}" class="card-img-top " alt="..." height="200px" width="250px">
          {% else %}
            <img src="{% static 'images/ship.png' %}" class="card-img-top" alt="..." height="200px" width="250px">
          {% endif %}
          <h5 class="card-title text-center">{{i.email}}</h5>
        <div >
          <ul class="list-group list-group-flush">
           
            <li class="list-group-item">Product Type: {{i.product_type}}</li>
            <li class="list-group-item">Departure: {{i.departure}}</li>
            <li class="list-group-item">Delivery: {{i.delivery}}</li> 
            <li class="list-group-item" >Days Left:
                {% if i.prediction %}
                    <span class="btn btn-outline-info btn-block" id="daysLeft{{ forloop.counter }}">{{i.prediction|floatformat:"0" }}</span>
                    <script>
                        // Function to decrement days and update the display
                        function decrementDays{{ forloop.counter }}() {
                            var daysLeftElement = document.getElementById('daysLeft{{ forloop.counter }}');
                            var daysLeft = parseInt(daysLeftElement.textContent);

                            // Decrement the value
                            daysLeft--;

                            // Update the display
                            daysLeftElement.textContent = daysLeft;

                            // Send an AJAX request to update the value in the database
                            var xhr = new XMLHttpRequest();
                            xhr.open('POST', '{% url "home:update_days" i.id %}', true);
                            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                            xhr.setRequestHeader('X-CSRFToken', csrftoken);
                            xhr.onreadystatechange = function () {
                                if (xhr.readyState === XMLHttpRequest.DONE) {
                                    if (xhr.status === 200) {
                                        var response = JSON.parse(xhr.responseText);
                                        if (!response.success) {
                                            console.error('Failed to update days in the database.');
                                        }
                                    } else {
                                        console.error('Error occurred while updating days in the database.');
                                    }
                                }
                            };
                            xhr.send('daysLeft=' + encodeURIComponent(daysLeft));
                        }

                        // Call decrementDays function when the page loads (optional)
                        window.onload = function() {
                            decrementDays{{ forloop.counter }}();
                        };
                    </script>
                {% else %}
                    <a class="btn btn-info" href="{% url 'home:p' i.id %}">Predict</a>
                {% endif %}
            </li> 

          </ul>
          </div>
        </div>         
        </div>
        </div>  
      {% endfor %} 
</div>
{% endblock %}
